<!DOCTYPE html>
<html lang="en" ng-app="myApp" ng-cloak th:fragment="admin(view)" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <!--NG TABLE-->
    <link rel="stylesheet" href="https://unpkg.com/ng-table@4.0.0/bundles/ng-table.css">
    <!-- notify -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.css"/>
    <!-- Calendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet"/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
          rel="stylesheet">

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            overflow: scroll;
        }

        .sidebar {
            min-height: 100vh;
            width: 300px;
            min-width: 250px;
        }

        .sidebar a:hover {
            background: #087592;
            background: linear-gradient(90deg, #087592 0%, #2494b1 100%);
            color: white !important;
        }

        .body-bg-color {
            /*background-color: #f1f6fc !important;*/
            background: url("/images/background/admin-bg.jpg") no-repeat center center fixed;
            background-size: cover;
        }

        .bg-color {
            background: linear-gradient(90deg, #087592 0%, #2494b1 100%);
            color: white;
        }

        .brand-text-color {
            background: linear-gradient(90deg, #087592 0%, #2494b1 100%);
            -webkit-background-clip: text;
            color: transparent; /* Đặt màu văn bản thành trong suốt */
        }

        .nav-pills .nav-link {
            padding: 20px 25px;
            border-radius: 15px;
        }

        .nav-pills .nav-link.active {
            background: linear-gradient(90deg, #087592 0%, #2494b1 100%);
            color: white !important;
        }

        .insert-btn {
            background: linear-gradient(90deg, #087592 0%, #2494b1 100%);
            color: white;
            border: none;
        }

        .insert-btn:hover {
            background: linear-gradient(90deg, #087592 0%, #2494b1 100%);
            color: white;
        }

        /*NG TABLE*/
        .ng-table th.sortable.sort-desc, .ng-table th.sortable.sort-asc {
            background: #c1d3ff;
            border-radius: 10px;
            color: white;
        }

        /*.ng-table th.sortable {*/
        /*    background: #1781ff;*/
        /*    border-radius: 10px;*/
        /*    color: #3259ff;*/
        /*}*/
        .ng-table-pager {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ng-table-filters {
            width: 100%;
        }

        .ng-table-filters input {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' height='50px' width=''><text x='10' y='50%' fill='gray' font-size='15'>Tìm kiếm</text></svg>");
            background-repeat: no-repeat;
            background-position-x: center;
        }

        .ng-table-filters input:focus {
            background-image: none;
        }

        .header {
            padding: 0;
        }

        .ng-table-header {
            color: #414450;
            font-weight: bold;
            background-color: #f1f6fc;
            border: 1px solid #6057cd;
            border-radius: 10px;
            padding: 10px;
            margin: 0;
        }

        /*HIỂN THỊ SỐ LƯỢNG PET*/
        .ng-table-counts {
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.28);
            border: 1px solid #6057cd;
        }

        .ng-table-counts .btn-default {
            white-space: nowrap; /* Ngăn văn bản xuống dòng */
            overflow: hidden; /* Ẩn văn bản vượt quá vùng chứa */
            text-overflow: ellipsis; /* Thêm dấu ... cho văn bản bị cắt */
            max-width: 150px; /* Đặt chiều rộng tối đa cho ô */
            padding: 10px 20px;
            background-color: white;
            color: #6057cd;
            border: 1px solid #6057cd;
        }

        .ng-table-counts .active {
            background-color: #6057cd;
            color: white;
        }

        .ng-table-pagination .page-item .ng-scope {
            border-radius: 0;
            padding: 10px 20px;
            font-weight: lighter;
            color: black;
            cursor: pointer;
            transition: color 0.3s;
            position: relative;
        }

        /*PHÂN TRANG*/
        .ng-table-pagination {
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.28);
            margin: 0;
            background: white;
        }

        .ng-table-pagination .page-item .ng-scope::after {
            content: '';
            display: block;
            height: 2px;
            background: black;
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .ng-table-pagination .page-item .ng-scope:hover::after {
            transform: scaleX(1);
        }

        .ng-table-pagination .active .page-link {
            background-color: #6057cd;
            font-weight: bold;
            color: white;
        }

        .container {
            max-width: 1600px;
        }
    </style>
</head>

<body ng-controller="myCtrl" ng-cloak>
<!-- Modal -->
<div th:insert="~{/admin/_petModal}"></div>
<div th:insert="~{/admin/_petAddModal}"></div>
<div th:insert="~{/admin/_productModal}"></div>
<div th:insert="~{/admin/_productAddModal}"></div>
<div th:insert="~{/admin/_userModal}"></div>
<!-- MAIN CONTENT -->
<main class="container-fluid p-0 d-flex">
    <div id="bdSidebar"
         class="sidebar d-flex flex-column flex-shrink-0 text-dark offcanvas-md offcanvas-start">
        <!-- Brand -->
        <div class="navbar-brand p-1 text-center">
            <h1 th:text="${#authorization.expression('hasRole(''ROLE_ADMIN'')') ? 'ADMIN' : 'STAFF'}"
                class="fw-bold brand-text-color" style="font-size: 60px">ADMIN</h1>
            <span class="fw-bold">{{date}}</span>
        </div>
        <hr class="m-0">
        <!-- Navigation -->
        <ul class="nav nav-pills flex-column mb-auto p-4" style="position: sticky;  top: 0;">
            <li class="nav-item mb-2">
                <a th:href="@{/quan-tri-he-thong}" class="nav-link text-dark">
                    <i class="fa-regular fa-user me-2"></i> Dashboard
                </a>
            </li>
            <!-- Settings Dropdown -->
            <li class="nav-item mb-1">
                <a th:href="@{/quan-tri-he-thong/pet}" class="nav-link text-dark">
                    <i class="fa-solid fa-paw"></i>
                    <span>Thú cưng</span>
                </a>
            </li>
            <li class="nav-item mb-1">
                <a th:href="@{/quan-tri-he-thong/product}" class="nav-link text-dark">
                    <i class="fa-solid fa-box"></i>
                    <span>Sản phẩm</span>
                </a>
            </li>
            <li sec:authorize="hasRole('ROLE_ADMIN')" class="nav-item mb-1">
                <a th:href="@{/quan-tri-he-thong/user}" class="nav-link text-dark">
                    <i class="fa-solid fa-user"></i>
                    <span>Người dùng</span>
                </a>
            </li>
            <li sec:authorize="hasRole('ROLE_ADMIN')" class="nav-item mb-1">
                <a th:href="@{/quan-tri-he-thong/authorization}" class="nav-link text-dark">
                    <i class="fa-solid fa-user-shield"></i>
                    <span>Phân quyền</span>
                </a>
            </li>
        </ul>
        <div class="d-flex justify-content-center align-items-center p-4">
            <button class="btn d-md-none rounded-pill bg-light p-3 btn-close" type="button"
                    data-bs-toggle="offcanvas" data-bs-target="#bdSidebar" aria-controls="bdSidebar"
                    aria-label="Mở menu">
            </button>
        </div>
    </div>
    <div class="body-bg-color flex-fill">
        <!-- MINI MENU -->
        <div th:insert="~{/admin/_miniMenu.html}"></div>
        <!-- TOP MENU -->
        <div class="" th:insert="~{/admin/_menu}"></div>
        <!-- MAIN CONTENT -->
        <!--SPA-->
        <div class="container animate__animated animate__fadeIn" th:insert="${view}"></div>
    </div>
</main>
<div th:insert=" ~{/admin/_loadingSpinner}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular-route.js"></script>
<script src="https://unpkg.com/ng-table@4.0.0/bundles/ng-table.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Thư viện XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>


<script type="text/javascript">
    var colors = ['#AEC6CF', '#FFB7B2', '#C3B1E1', '#FFDAC1', '#FFB6C1', '#B5EAD7', '#FFDFBA', '#FDFD96', '#B3E5FC', '#FADADD'];
    /* Bôi màu cho menu hiện tại thoôi nhìn gì?*/
    const currentUrl = window.location.pathname;
    const links = document.querySelectorAll('.nav-link');
    links.forEach(link => {
        if (link.getAttribute('href') === currentUrl) {
            link.classList.add('active', 'fw-bold');
        }
    });
    /* Đây mới là phần chính của AngularJS nè =))*/
    var app = angular.module('myApp', ['ngRoute', 'ngTable']);
    app.controller('myCtrl', function ($scope, $http, NgTableParams) {
            $scope.selectedPet = {};
            $scope.petData = [];
            $scope.petCategoryData = [];
            $scope.productData = [];
            var baseUrl = 'http://localhost:8080/api/';
            /*PET*/
            $scope.getPets = function () {
                $http.get(baseUrl + 'pet').then(function (response) {
                    $scope.petData = response.data;
                    $scope.petAvailableTrueLength = $scope.petData.filter(pet => pet.available === true).length;
                    $scope.petAvailableFalseLength = $scope.petData.filter(pet => pet.available === false).length;
                    $scope.petEnableTrueLength = $scope.petData.filter(pet => pet.enable === true).length;
                    $scope.petEnableFalseLength = $scope.petData.filter(pet => pet.enable === false).length;
                    // PET TABLE
                    $scope.petsTable = new NgTableParams({
                        page: 1,
                        count: 5
                    }, {
                        counts: ['Hiển thị', '5', '10', '20', '30', '50', $scope.petData.length],
                        dataset: $scope.petData
                    });
                    const petCounts = $scope.petData.reduce((petTemp, currentPet) => {
                        const categoryName = currentPet.petCategoryID.petCategoryName;
                        petTemp[categoryName] = (petTemp[categoryName] || 0) + 1;
                        return petTemp;
                    }, {});
                    $scope.petLabelsChart = Object.keys(petCounts);
                    $scope.petDataChart = Object.values(petCounts);
                    // Tạo biểu đồ
                    new Chart(document.getElementById('petChart-Bar').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: $scope.petLabelsChart,
                            datasets: [{
                                label: 'Số lượng từng loài',
                                data: $scope.petDataChart,
                                backgroundColor: colors.slice(0, $scope.petLabelsChart.length),
                                borderColor: colors.slice(0, $scope.petLabelsChart.length),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: true,
                                    labels: {
                                        generateLabels: function (chart) {
                                            return chart.data.labels.map((label, index) => {
                                                return {
                                                    text: label,
                                                    fillStyle: colors[index],
                                                    strokeStyle: colors[index],
                                                    lineWidth: 1,
                                                    index: index
                                                };
                                            });
                                        }
                                    }
                                }
                            }
                        }
                    });
                }).catch(function (error) {
                    console.error('Lỗi khi lấy dữ liệu thú cưng:', error);
                });
            };
            $scope.getPets();
            $scope.petEdit = function (pet) {
                $scope.selectedPet = angular.copy(pet);
                var editPetModal = new bootstrap.Modal(document.getElementById('editPetModal'), {
                    keyboard: true
                });
                editPetModal.show();
            };
            $scope.addPetModal = function () {
                $scope.selectedPet = {
                    petID: null,
                    breed: null,
                    age: null,
                    hair: null,
                    famous: null,
                    petDescription: null,
                    gender: true,
                    available: false,
                    photo: 'pet-placeholder.png',
                    enable: true,
                    petCategoryID: {
                        id: 1
                    }
                };
                var addPetModal = new bootstrap.Modal(document.getElementById('addPetModal'), {
                    keyboard: true
                });
                addPetModal.show();
            };
            $scope.addPet = function (petID) {
                if ($scope.selectedPet.petID == null) {
                    new Notify({
                        title: 'Thông báo',
                        text: 'Vui lòng nhập đầy đủ thông tin :',
                        autoclose: true,
                        status: 'error',
                        autotimeout: 3000
                    });
                } else {
                    $http.get(baseUrl + 'pet/' + petID).then(function (response) {
                        if (response.data) { // Kiểm tra nếu có dữ liệu trả về
                            new Notify({
                                title: 'Thông báo',
                                text: 'ID pet đã tồn tại!',
                                autoclose: true,
                                status: 'error',
                                autotimeout: 3000
                            });
                        } else {
                            $http.post(baseUrl + 'pet', $scope.selectedPet).then(function (response) {
                                new Notify({
                                    title: 'Thông báo',
                                    text: 'Thêm mới thành công :' + petID,
                                    autoclose: true,
                                    status: 'success',
                                    autotimeout: 3000
                                });
                                $scope.getPets();
                            }).catch(function (error) {
                                new Notify({
                                    title: 'Thông báo',
                                    text: 'Lỗi khi thêm mới :' + petID,
                                    autoclose: true,
                                    status: 'warning',
                                    autotimeout: 3000
                                });
                            });
                        }
                    }).catch(function (error) {
                        // Xử lý lỗi nếu có
                        new Notify({
                            title: 'Thông báo',
                            text: 'Có lỗi xảy ra khi kiểm tra ID pet.',
                            autoclose: true,
                            status: 'error',
                            autotimeout: 3000
                        });
                    });
                }
            };
            $scope.updatePet = function (petId) {
                if (petId == null) {
                    new Notify({
                        title: 'Thông báo',
                        text: 'Vui lòng nhập đầy đủ thông tin :',
                        autoclose: true,
                        status: 'error',
                        autotimeout: 3000
                    });
                } else {
                    $http.put(baseUrl + 'pet/' + petId, $scope.selectedPet).then(function (response) {
                        new Notify({
                            title: 'Thông báo',
                            text: 'Cập nhật thành công :' + petId,
                            autoclose: true,
                            status: 'success',
                            autotimeout: 3000
                        });
                        $scope.getPets();
                    }).catch(function (error) {
                        new Notify({
                            title: 'Thông báo',
                            text: 'Lỗi khi cập nhật :' + petId,
                            autoclose: true,
                            status: 'warning',
                            autotimeout: 3000
                        });
                    });
                }
            };
            $scope.deletePet = function (petId) {
                Swal.fire({
                    title: 'Bạn có chắc chắn muôn xóa?' + petId,
                    text: "Bạn sẽ không thể khôi phục hành động này!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận!',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $http.delete(baseUrl + 'pet/' + petId).then(function (response) {
                            Swal.fire({
                                title: 'Đã xóa!',
                                text: 'Pet có ID: ' + petId + ' đã được xóa thành công.',
                                icon: 'success',
                                timer: 3000,
                                showConfirmButton: false
                            });
                            $scope.getPets();
                        }).catch(function (error) {
                            Swal.fire({
                                title: 'Lỗi!',
                                text: 'Lỗi khi xóa pet có ID: ' + petId,
                                icon: 'error',
                                timer: 3000,
                                showConfirmButton: false
                            });
                        });
                    }
                });
            };
            $scope.clearPetFilter = function () {
                $scope.petsTable.filter({});
                $scope.petsTable.sorting({});
            };
            /*PRODUCT*/
            $scope.getProducts = function () {
                $http.get(baseUrl + 'product').then(function (response) {
                    $scope.productData = response.data;
                    $scope.productAvailableTrueLength = $scope.productData.filter(product => product.available === true).length;
                    $scope.productAvailableFalseLength = $scope.productData.filter(product => product.available === false).length;
                    $scope.productTotalQuantity = $scope.productData.filter(product => product.quantity).reduce((total, product) => total + product.quantity, 0);
                    $scope.productTotalPrice = $scope.productData.filter(product => product.price).reduce((total, product) => total + product.price * product.quantity, 0);
                    // PRODUCT TABLE
                    $scope.productsTable = new NgTableParams({
                        page: 1,
                        count: 5,
                        sorting: {
                            id: 'desc'
                        }
                    }, {
                        counts: ['Hiển thị', '5', '10', '20', '30', '50', $scope.productData.length],
                        dataset: $scope.productData
                    });
                    // PRODUCT CHART
                    const productCounts = $scope.productData.reduce((productTemp, currentProduct) => {
                        const categoryName = currentProduct.productCategoryID.productCategoryName;
                        productTemp[categoryName] = (productTemp[categoryName] || 0) + 1;
                        return productTemp;
                    }, {});
                    $scope.productLabelsChart = Object.keys(productCounts);
                    $scope.productDataChart = Object.values(productCounts);
                    // Tạo biểu đồ
                    new Chart(document.getElementById('productChart-Bar').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: $scope.productLabelsChart,
                            datasets: [{
                                label: 'Số lượng từng sản phẩm',
                                data: $scope.productDataChart,
                                backgroundColor: colors.slice(0, $scope.productLabelsChart.length),
                                borderColor: colors.slice(0, $scope.productLabelsChart.length),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: true,
                                    labels: {
                                        generateLabels: function (chart) {
                                            return chart.data.labels.map((label, index) => {
                                                return {
                                                    text: label,
                                                    fillStyle: colors[index],
                                                    strokeStyle: colors[index],
                                                    lineWidth: 1,
                                                    index: index
                                                };
                                            });
                                        }
                                    }
                                }
                            }
                        }
                    });
                }).catch(function (error) {
                    console.error('Lỗi khi lấy dữ liệu sản phẩm:', error);
                });
            };
            $scope.getProducts();
            $scope.productEdit = function (product) {
                $scope.selectedProduct = angular.copy(product);
                var editProductModal = new bootstrap.Modal(document.getElementById('editProductModal'), {
                    keyboard: true
                });
                editProductModal.show();
            };
            $scope.productAddModal = function () {
                $scope.selectedProduct = {
                    productName: null,
                    price: null,
                    quantity: null,
                    available: true,
                    photo: 'product-placeholder.png',
                    productCategoryID: {
                        id: 1
                    }
                };
                var show = new bootstrap.Modal(document.getElementById('modalAddProduct'), {
                    keyboard: true
                });
                show.show();
            };
            $scope.addProduct = function () {
                $http.post(baseUrl + 'product', $scope.selectedProduct).then(function (response) {
                    new Notify({
                        title: 'Thông báo',
                        text: 'Thêm mới thành công :',
                        autoclose: true,
                        status: 'success',
                        autotimeout: 3000
                    });
                    $scope.getProducts();
                }).catch(function (error) {
                    new Notify({
                        title: 'Thông báo',
                        text: 'Lỗi khi thêm mới :',
                        autoclose: true,
                        status: 'warning',
                        autotimeout: 3000
                    });
                });
            };
            $scope.updateProduct = function (productId) {
                if (productId == null) {
                    new Notify({
                        title: 'Thông báo',
                        text: 'Vui lòng nhập đầy đủ thông tin :',
                        autoclose: true,
                        status: 'error',
                        autotimeout: 3000
                    });
                } else {
                    $http.put(baseUrl + 'product/' + productId, $scope.selectedProduct).then(function (response) {
                        new Notify({
                            title: 'Thông báo',
                            text: 'Cập nhật thành công :' + productId,
                            autoclose: true,
                            status: 'success',
                            autotimeout: 3000
                        });
                        $scope.getProducts();
                    }).catch(function (error) {
                        new Notify({
                            title: 'Thông báo',
                            text: 'Lỗi khi cập nhật :' + productId,
                            autoclose: true,
                            status: 'warning',
                            autotimeout: 3000
                        });
                    });
                }
            };
            $scope.deleteProduct = function (productId) {
                Swal.fire({
                    title: 'Bạn có chắc chắn muôn xóa?',
                    text: "Bạn sẽ không thể khôi phục hành động này!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận!',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $http.delete(baseUrl + 'product/' + productId).then(function (response) {
                            Swal.fire({
                                title: 'Đã xóa!',
                                text: 'Sản phẩm có ID: ' + productId + ' đã được xóa thành công.',
                                icon: 'success',
                                timer: 3000,
                                showConfirmButton: false
                            });
                            $scope.getProducts();
                        }).catch(function (error) {
                            Swal.fire({
                                title: 'Lỗi!',
                                text: 'Lỗi khi xóa sản phẩm có ID: ' + productId,
                                icon: 'error',
                                timer: 3000,
                                showConfirmButton: false
                            });
                        });
                    }
                });
            };
            $scope.clearProductFilter = function () {
                $scope.productsTable.filter({});
                $scope.productsTable.sorting({});
            };
            /*USER*/
            $scope.getUsers = function () {
                $http.get(baseUrl + 'user').then(function (response) {
                    $scope.userData = response.data;
                    $scope.userEnableTrueLength = $scope.userData.filter(user => user.enable === true).length;
                    $scope.userEnableFalseLength = $scope.userData.filter(user => user.enable === false).length;
                    // PRODUCT TABLE
                    $scope.usersTable = new NgTableParams({
                        page: 1,
                        count: 5
                    }, {
                        counts: ['Hiển thị', '5', '10', '20', '30', '50', $scope.userData.length],
                        dataset: $scope.userData
                    });
                }).catch(function (error) {
                    console.error('Lỗi khi lấy dữ liệu người dùng:', error);
                });
            };
            $scope.getUsers();
            $scope.userEdit = function (user) {
                $scope.selectedUser = angular.copy(user);
                var editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'), {
                    keyboard: true
                });
                editUserModal.show();
            };
            $scope.updateUser = function (username) {
                if (username == null) {
                    new Notify({
                        title: 'Thông báo',
                        text: 'Vui lòng nhập đầy đủ thông tin',
                        autoclose: true,
                        status: 'error',
                        autotimeout: 3000
                    });
                } else {
                    $http.put(baseUrl + 'user/' + username, $scope.selectedUser).then(function (response) {
                        new Notify({
                            title: 'Thông báo',
                            text: 'Cập nhật thành công :' + $scope.selectedUser.fullName,
                            autoclose: true,
                            status: 'success',
                            autotimeout: 3000
                        });
                        $scope.getUsers();
                    }).catch(function (error) {
                        new Notify({
                            title: 'Thông báo',
                            text: 'Lỗi khi cập nhật :' + $scope.selectedUser.fullName,
                            autoclose: true,
                            status: 'warning',
                            autotimeout: 3000
                        });
                    });
                }
            };
            $scope.clearUserFilter = function () {
                $scope.usersTable.filter({});
                $scope.usersTable.sorting({});
            };
            /*PET CATEGORY*/
            $scope.getPetCategories = function () {
                $http.get(baseUrl + 'pet-category').then(function (response) {
                    $scope.petCategoryData = response.data;
                }).catch(function (error) {
                    console.error('Lỗi khi lấy dữ liệu loại thú cưng:', error);
                });
            };
            $scope.getPetCategories();
            /*PRODUCT CATEGORY*/
            $scope.getProductCategories = function () {
                $http.get(baseUrl + 'product-category').then(function (response) {
                    $scope.productCategoryData = response.data;
                }).catch(function (error) {
                    console.error('Lỗi khi lấy dữ liệu loại sản phẩm:', error);
                });
            };
            $scope.getProductCategories();
            /*ROLE*/
            $scope.getRoles = function () {
                $http.get(baseUrl + 'role').then(function (response) {
                    $scope.roleData = response.data;
                }).catch(function (error) {
                    console.error('Lỗi khi lấy dữ liệu role:', error);
                });
            };
            $scope.getRoles();
            /*AUTHORITY*/
            $scope.getAuthorities = function () {
                $http.get(baseUrl + 'authority').then(function (response) {
                    $scope.authorityData = response.data;
                    $scope.authorityTables = new NgTableParams({
                        page: 1,
                        count: 5
                    }, {
                        counts: ['Hiển thị', '5', '10', '20', '30', '50', $scope.authorityData.length],
                        dataset: $scope.authorityData
                    });
                }).catch(function (error) {
                    console.error('Lỗi khi lấy dữ liệu authority:', error);
                });
            };
            $scope.getAuthorities();
            $scope.changeRole = function (authorityId, role) {
                Swal.fire({
                    title: 'Bạn có chắc chắn muốn thay đổi?',
                    text: 'Vai trò sẽ được thay đổi thành ' + role.replace('ROLE_', ''),
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận!',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $http.put(baseUrl + 'authority/' + authorityId + '/' + role).then(function (response) {
                            new Notify({
                                title: 'Thông báo',
                                text: 'Thay đổi vai trò thành công',
                                autoclose: true,
                                status: 'success',
                                autotimeout: 3000
                            });
                            $scope.getAuthorities();
                        }).catch(function (error) {
                            new Notify({
                                title: 'Thông báo',
                                text: 'Lỗi khi thay đổi role',
                                autoclose: true,
                                status: 'warning',
                                autotimeout: 3000
                            });
                        });
                    } else {
                        new Notify({
                            title: 'Thông báo',
                            text: 'Đã hủy',
                            autoclose: true,
                            status: 'info',
                            autotimeout: 3000
                        });
                        $scope.getAuthorities();
                    }
                });
            };

            /*EXCEL EXPORT*/
            $scope.exportExcelPet = function () {
                try {
                    const data = $scope.petData.map((pet, index) => ({
                        "STT": index + 1,
                        "Pet ID": pet.fullName,
                        "Loài": pet.petCategoryID.petCategoryName,
                        "Giống": pet.breed,
                        "Tuổi": pet.age,
                        "Kiểu lông": pet.hair,
                        "Màu lông": pet.famous,
                        "Giá": pet.price.toLocaleString("vi-VN") + " đ",
                        "Giới tính": pet.gender ? "Đực" : "Cái",
                        "Tình trạng": pet.available ? "Đã bán" : "Chưa bán",
                        "Mô tả": pet.petDescription,
                        "Hình ảnh": pet.photo,
                    }));
                    const totalPrice = $scope.petData.reduce((total, pet) => total + pet.price, 0);
                    const totalPets = data.length;
                    data.push({
                        "STT": "Tổng số thú cưng",
                        "Pet ID": totalPets,
                        "Loài": "",
                        "Giống": "",
                        "Tuổi": "",
                        "Kiểu lông": "",
                        "Màu lông": "",
                        "Giá": "",
                        "Giới tính": "",
                        "Tình trạng": "",
                        "Mô tả": "",
                        "Hình ảnh": "",
                    });
                    data.push({
                        "STT": "Tổng giá trị",
                        "Pet ID": totalPrice.toLocaleString("vi-VN") + " đ",
                        "Loài": "",
                        "Giống": "",
                        "Tuổi": "",
                        "Kiểu lông": "",
                        "Màu lông": "",
                        "Giá": "",
                        "Giới tính": "",
                        "Tình trạng": "",
                        "Mô tả": "",
                        "Hình ảnh": "",
                    });
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data));
                    XLSX.writeFile(wb, "Danh sách thú cưng.xlsx");
                    Swal.fire({
                        title: 'Thành công!',
                        text: 'Đã xuất file Excel',
                        icon: 'success',
                        timer: 3000,
                        showConfirmButton: false
                    });
                } catch (error) {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra khi xuất file Excel',
                        icon: 'error',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
            };
            $scope.exportExcelProduct = function () {
                try {
                    const data = $scope.productData.map((user, index) => ({
                        "STT": index + 1,
                        "Tên sản phẩm": user.productName,
                        "Loại": user.productCategoryID.productCategoryName,
                        "Giá": user.price.toLocaleString("vi-VN") + " đ",
                        "Số lượng": user.quantity,
                        "Tình trạng": user.available ? "Còn hàng" : "Hết hàng",
                        "Hình ảnh": user.photo,
                        "Mô tả": user.productDescription,
                    }));
                    const totalProducts = data.length;
                    const totalCost = $scope.productData.reduce((total, product) => total + product.price * product.quantity, 0);
                    const totalProductQuantity = $scope.productData.reduce((total, product) => total + product.quantity, 0);
                    data.push({
                        "STT": "Tổng số sản phẩm",
                        "Tên sản phẩm": totalProducts,
                        "Loại": "",
                        "Giá": "",
                        "Số lượng": "",
                        "Tình trạng": "",
                        "Hình ảnh": "",
                        "Mô tả": "",
                    });
                    data.push({
                        "STT": "Tổng số lượng",
                        "Tên sản phẩm": totalProductQuantity,
                        "Loại": "",
                        "Giá": "",
                        "Số lượng": "",
                        "Tình trạng": "",
                        "Hình ảnh": "",
                        "Mô tả": "",
                    });
                    data.push({
                        "STT": "Tổng giá trị",
                        "Tên sản phẩm": totalCost.toLocaleString("vi-VN") + " đ",
                        "Loại": "",
                        "Giá": "",
                        "Số lượng": "",
                        "Tình trạng": "",
                        "Hình ảnh": "",
                        "Mô tả": "",
                    });
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data));
                    XLSX.writeFile(wb, "Danh sách sản phẩm.xlsx");
                    Swal.fire({
                        title: 'Thành công!',
                        text: 'Đã xuất file Excel',
                        icon: 'success',
                        timer: 3000,
                        showConfirmButton: false
                    });
                } catch (error) {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra khi xuất file Excel',
                        icon: 'error',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
            }
            $scope.exportExcelUser = function () {
                try {
                    const data = $scope.userData.map((user, index) => ({
                        "STT": index + 1,
                        "Họ và tên": user.fullName,
                        "Ngày tạo": new Date(user.dateCreated).toLocaleDateString("vi-VN"),
                        "Địa chỉ": user.userAddress,
                        "Số điện thoại": user.phoneNumber.toString(),
                        "Email": user.email,
                        "Trạng thái": user.enable ? "Đang hoạt động" : "Không hoạt động"
                    }));
                    const totalUsers = data.length;
                    data.push({
                        "STT": "Tổng số người dùng",
                        "Họ và tên": totalUsers,
                        "Ngày tạo": "",
                        "Địa chỉ": "",
                        "Số điện thoại": "",
                        "Email": "",
                        "Trạng thái": "",
                    });
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data));
                    XLSX.writeFile(wb, "Danh sách người dùng.xlsx");
                    Swal.fire({
                        title: 'Thành công!',
                        text: 'Đã xuất file Excel',
                        icon: 'success',
                        timer: 3000,
                        showConfirmButton: false
                    });
                } catch (error) {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra khi xuất file Excel',
                        icon: 'error',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
            };
            // Lấy ngày giờ hiện tại
            $scope.date = new Date().toLocaleString();
            setInterval(function () {
                $scope.$apply(function () {
                    $scope.date = new Date().toLocaleString();
                });
            }, 1000);

            // Cập nhật tên ảnh khi chọn file
            $scope.updatePhotoPetName = function (input) {
                if (input.files && input.files[0]) {
                    var fileName = input.files[0].name;
                    $scope.selectedPet.photo = fileName;
                    $scope.$apply();
                }
            };
            $scope.updatePhotoProductName = function (input) {
                if (input.files && input.files[0]) {
                    var fileName = input.files[0].name;
                    $scope.selectedProduct.photo = fileName;
                    $scope.$apply();
                }
            };
        }
    );
</script>
</body>

</html>